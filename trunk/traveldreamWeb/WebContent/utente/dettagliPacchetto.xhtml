<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns:p="http://primefaces.org/ui"
      xmlns:ui="http://java.sun.com/jsf/facelets">

<ui:composition template="/template.xhtml">

<ui:define name="title">Dettagli pacchetto</ui:define>

<ui:define name="content">

<f:metadata>
	<f:viewParam name="idPacchetto" binding="#{id}" />
	<f:event listener="#{pacchetto.getPacchetto(id.value)}" type="preRenderView" />
</f:metadata>

<p:messages showDetail="false" autoUpdate="true" />

<h:panelGroup rendered="#{pacchetto.pacchetto.id != 0}">

	<!-- Nome del pacchetto -->
	<h1 id="nomePacchetto" style="display: block;">
		#{pacchetto.pacchetto.nome}
		<h:commandButton styleClass="matita" onclick="toggle('nomePacchetto'); toggle('modificaNome'); return false;" rendered="#{pacchetto.tipoPersonalizzato or pacchetto.tipoPredefinito}" />
	</h1>
		
	<!-- Modifica nome del pacchetto -->
	<h1 id="modificaNome" style="display: none;">
		<h:form>
			<h:inputText value="#{pacchetto.pacchetto.nome}" required="true" requiredMessage="Il pacchetto deve avere un nome" />
			<h:commandButton value="salva" action="#{pacchetto.modificaNomePacchetto()}" oncomplete="toggle('nomePacchetto'); toggle('modificaNome'); return false;" />
			<h:commandButton value="annulla" onclick="toggle('nomePacchetto'); toggle('modificaNome'); return false;" />
		</h:form>		
	</h1>    
	
	<!-- Blocco con i pulsanti per l'eliminazione, la condivisione e l'acquisto del pacchetot -->
	<div class="bloccoModifica">
		<p:commandButton value="Elimina pacchetto" styleClass="pacc-button" action="#{pacchetto.eliminaPacchetto()}"/>
		<p:commandButton value="Condividi pacchetto" styleClass="pacc-button" onclick="PF('condividiPacchetto').show()" disabled="#{not (pacchetto.tipoPersonalizzato or pacchetto.tipoPredefinito)}" />
		
		<!-- Dialog che compare in sovraimpressione per inserire i dati dell'amico -->
		<p:dialog header="Condividi" widgetVar="condividiPacchetto" resizable="false">
			<h:panelGroup>		
				<h:form>
	   			 	<h:panelGrid columns="2" style="margin-bottom:10px">        			 
	       				<h:outputLabel for="email" value="email:" />  
	         			<p:inputText id="email" binding="#{emailAmico}" />
	         			
	         			<h:outputLabel for="nome" value="Nome:" />  
	         			<p:inputText id="nome" binding="#{nomeAmico}" />
	         			
	         			<h:outputLabel for="cognome" value="Cognome:" />  
	         			<p:inputText id="cognome" binding="#{cognomeAmico}" />
	       			</h:panelGrid>  
	 
	       			<p:commandButton value="Condividi" action="#{pacchetto.condividiPacchetto(emailAmico.value,nomeAmico.value,cognomeAmico.value)}" oncomplete="PF('condividiPacchetto').hide();" />
      			</h:form>
      		</h:panelGroup>
		</p:dialog>
		
		<p:commandButton value="Acquista pacchetto" styleClass="pacc-button" action="#{pacchetto.acquistaPacchetto()}" disabled="#{not (pacchetto.tipoPersonalizzato or pacchetto.tipoPredefinito)}"/>
	</div>	
	
	<!-- Dettagli del pacchetto -->
	<div id="dettagliPacchetto" class="bloccoPacc">
		<!-- Immagine del pacchetto -->
		<h:graphicImage library="images/citta" name="#{pacchetto.getImmagine(id.value)}" width="288" height="174" />
		
		<!-- Informazioni generali sul pacchetto -->
		<div class="descr">		
			<div>	
				<p>Città di partenza</p>
				<h2 id="cittaPartenza" style="display: block;">
					<h:outputText value="#{pacchetto.pacchetto.citta.nome}" />
					<h:commandButton styleClass="flight-button" value="modifica" onclick="toggle('cittaPartenza'); toggle('modificaCittaPartenza'); return false;" rendered="#{pacchetto.tipoPersonalizzato}" />
					<h:commandButton styleClass="flight-button" value="modifica" onclick="toggle('cittaPartenza'); toggle('modificaCittaPartenzaPred'); return false;" rendered="#{pacchetto.tipoPredefinito}" />					
				</h2>
				
				<!-- Modifica della città di partenza -->
				<h2 id="modificaCittaPartenza" style="display: none;">
					<h:form>
						<h:selectOneMenu binding="#{nuovaCittaPartenza}">
							<f:selectItems value="#{citta.nomiCitta}" />
						</h:selectOneMenu>			
						<h:commandButton action="#{pacchetto.modificaCittaPartenza(nuovaCittaPartenza.value)}" oncomplete="toggle('cittaPartenza'); toggle('modificaCittaPartenza'); return false;" value="salva" />
						<h:commandButton value="annulla" onclick="toggle('cittaPartenza'); toggle('modificaCittaPartenza'); return false;" />
					</h:form>
				</h2>
				
				<!-- Modifica della città di partenza di un pacchetto predefinito -->
				<h2 id="modificaCittaPartenzaPred" style="display: none;">
					<h:form>
		                <h:selectOneMenu styleClass="menu-pred" binding="#{nuovaCittaPartenzaPred}">
							<f:selectItems value="#{pacchetto.predefinito.cittaPartenza}" var="citta" itemValue="#{citta.nome}" itemLabel="#{citta.nome}" />
						</h:selectOneMenu>
						<h:commandButton action="#{pacchetto.modificaCittaPartenza(nuovaCittaPartenzaPred.value)}" oncomplete="toggle('cittaPartenza'); toggle('modificaCittaPartenzaPred'); return false;" value="salva" />
						<h:commandButton value="annulla" onclick="toggle('cittaPartenza'); toggle('modificaCittaPartenzaPred'); return false;" />			
					</h:form>
				</h2>				
			</div>
			<br></br>
			<p>Numero di partecipanti</p>
			<h2 id="numeroPartecipanti" style="display: block;">
				<h:outputText value="#{pacchetto.pacchetto.numPartecipanti}" />
				<h:commandButton styleClass="flight-button" value="modifica" onclick="toggle('numeroPartecipanti'); toggle('modificaNumeroPartecipanti'); return false;" rendered="#{pacchetto.tipoPersonalizzato or pacchetto.tipoPredefinito}" />
			</h2>
			
			<!-- Modifica del numero di partecipanti -->
			<h2 id="modificaNumeroPartecipanti" style="display: none;">
				<h:form>
					<p:inputText value="#{pacchetto.pacchetto.numPartecipanti}" style="width: 150px;"
						required="true" requiredMessage="Inserire un numero di partecipanti" 
						converterMessage="Il numero di partecipanti deve essere composto solo da numeri" />
					<h:commandButton styleClass="flight-button" action="#{pacchetto.modificaNumeroPartecipanti()}" oncomplete="toggle('numeroPartecipanti'); toggle('modificaNumeroPartecipanti'); return false;" value="salva" />
					<h:commandButton styleClass="flight-button" onclick="toggle('numeroPartecipanti'); toggle('modificaNumeroPartecipanti'); return false;" value="annulla" />				
				</h:form>
			</h2>			
		</div>
		
		<!-- Prezzo del pacchetto -->
		<h:panelGroup id="prezzoPacchetto" styleClass="pulsanti" layout="block">
			<div id="prezzo">#{pacchetto.pacchetto.prezzo} €</div>
		</h:panelGroup>
	</div>	

<ui:repeat id="destinazioni" var="d" value="#{pacchetto.pacchetto.destinazioni}" varStatus="status">		
					
	<!-- Collegamento di andata -->
	<div class="bloccoPaccVolo">

		<!-- Data di partenza -->
		<p>Data di partenza</p>
		
		<h:panelGroup id="dataArrivo" style="display: block;" layout="block">
			<p>
				<h:outputText value="#{d.dataArrivo}">
					<f:convertDateTime pattern="dd/MM/yyyy" timeZone="Europe/Rome" />
				</h:outputText>
			</p>
			<h:commandButton value="modifica" onclick="toggle('destinazioni:#{status.index}:dataArrivo'); toggle('destinazioni:#{status.index}:modificaDataArrivo'); return false;" rendered="#{pacchetto.tipoPersonalizzato}" />
			<h:commandButton value="modifica" onclick="toggle('destinazioni:#{status.index}:dataArrivo'); toggle('destinazioni:#{status.index}:modificaDataArrivoPredefinito'); return false;" rendered="#{pacchetto.tipoPredefinito}" />
		</h:panelGroup>
		
		<h:panelGroup id="modificaDataArrivo" style="display: none;" layout="block">
			<h:form>
				<p:calendar value="#{d.dataArrivo}" locale="it" pattern="dd/MM/yyyy"
					required="true" requiredMessage="Inserire una data di partenza"
					converterMessage="Inserire una data di partenza nel formato dd/MM/yyyy (es.: 05/01/2014)">
	           			<f:convertDateTime pattern="dd/MM/yyyy" timeZone="Europe/Rome" />
	           	</p:calendar>
	           	<h:commandButton value="salva" action="#{pacchetto.modificaDataArrivo(d)}" oncomplete="toggle('destinazioni:#{status.index}:dataArrivo'); toggle('destinazioni:#{status.index}:modificaDataArrivo'); return false;" />
	           	<h:commandButton value="annulla" onclick="toggle('destinazioni:#{status.index}:dataArrivo'); toggle('destinazioni:#{status.index}:modificaDataArrivo'); return false;" />
           	</h:form>
		</h:panelGroup>				
		
		<h:panelGroup id="modificaDataArrivoPredefinito" style="display: none;" layout="block">
			<h:form>
				<h:selectOneMenu binding="#{dataArrivoPred}">
					<f:selectItems value="#{pacchetto.predefinito.datePartenza}" var="dataArrivo" itemLabel="#{data.getData(dataArrivo)}" itemValue="#{data.getData(dataArrivo)}" />			
				</h:selectOneMenu>
	           	<h:commandButton value="salva" action="#{pacchetto.modificaDataPredefinito(dataArrivoPred.value,d)}" oncomplete="toggle('destinazioni:#{status.index}:dataArrivo'); toggle('destinazioni:#{status.index}:modificaDataArrivoPredefinito'); return false;" />
	           	<h:commandButton value="annulla" onclick="toggle('destinazioni:#{status.index}:dataArrivo'); toggle('destinazioni:#{status.index}:modificaDataArrivoPredefinito'); return false;" />
           	</h:form>							
		</h:panelGroup>
		
		<div class="volo">
					
			<div class="pulsantiVolo">
				<p>
					<h:link value="Dettagli" styleClass="detail-button" outcome="dettagliCollegamento" disabled="#{not pacchetto.esisteCollegamento(d.dataArrivo)}">
						<f:param name="idPacchetto" value="#{pacchetto.pacchetto.id}" />
						<f:param name="codiceCollegamento" value="#{pacchetto.getCollegamento(d.dataArrivo).codice}" />
					</h:link>
				</p>
				<p>
					<h:link value="Modifica" styleClass="detail-button" outcome="aggiuntaCollegamento" disabled="#{not ((pacchetto.tipoPersonalizzato or pacchetto.tipoPredefinito) and pacchetto.esisteCollegamento(d.dataArrivo))}">
						<f:param name="idPacchetto" value="#{pacchetto.pacchetto.id}" />
						<f:param name="dataPartenza" value="#{data.getData(d.dataArrivo)}" />
						<f:param name="cittaPartenza" value="#{pacchetto.getCittaPartenza(d)}" />
						<f:param name="cittaArrivo" value="#{d.citta.nome}" />			
					</h:link>
				</p>
			</div>
			
			<div class="etichette">
				<ul>
					<li>Da</li>
					<li>A</li>
					<li>Partenza</li>
					<li>Arrivo</li>
					<li>Prezzo</li>
				</ul>
			</div>			
				
			<!-- Blocco dettagli volo -->
			<h:panelGroup styleClass="dati" layout="block" rendered="#{pacchetto.esisteCollegamento(d.dataArrivo)}">
				<ul>
					<li>#{pacchetto.getCollegamento(d.dataArrivo).cittaPartenza.nome} #{pacchetto.getCollegamento(d.dataArrivo).origine}</li>
					<li>#{pacchetto.getCollegamento(d.dataArrivo).cittaArrivo.nome} #{pacchetto.getCollegamento(d.dataArrivo).destinazione}</li>
					<li>
						<h:outputText value="#{pacchetto.getCollegamento(d.dataArrivo).oraPartenza}">
							<f:convertDateTime pattern="HH:mm" timeZone="Europe/Rome" />
						</h:outputText>
					</li>
					<li>
						<h:outputText value="#{pacchetto.getCollegamento(d.dataArrivo).oraArrivo}">
							<f:convertDateTime pattern="HH:mm" timeZone="Europe/Rome" />
						</h:outputText>
					</li>
					<li>#{pacchetto.getCollegamento(d.dataArrivo).prezzo} €</li>
				</ul>
			</h:panelGroup>
				
			<!-- Blocco aggiunta volo -->
			<h:panelGroup styleClass="dati" layout="block" rendered="#{not pacchetto.esisteCollegamento(d.dataArrivo)}">
               	<p>
               		<h:link value="Aggiungi collegamento" outcome="aggiuntaCollegamento">
                  		<f:param name="idPacchetto" value="#{pacchetto.pacchetto.id}" />
						<f:param name="dataPartenza" value="#{data.getData(d.dataArrivo)}" />
						<f:param name="cittaPartenza" value="#{pacchetto.getCittaPartenza(d)}" />
						<f:param name="cittaArrivo" value="#{d.citta.nome}" />
                  	</h:link>
                  </p>
              </h:panelGroup>               
			
		</div>
	</div>
		
	<!-- Informazioni sulla destinazione -->
	<div class="bloccoPacc">
		<div class="descr">
			<p>Città di destinazione</p>
			<h2>#{d.citta.nome}</h2>
		</div>
			
		<h:form>
			<h:commandButton value="Elimina" styleClass="detail-button" action="#{pacchetto.eliminaDestinazione(d)}" disabled="#{not pacchetto.tipoPersonalizzato}"/>
		</h:form>
			
		<!-- Informazioni sull'hotel -->
		<div class="hotelPacc">
			<h:graphicImage library="images/hotel" name="#{d.hotel.immagine.equals('NULL') ? 'noImage.png' : d.hotel.immagine}" width="195" height="113" />
			<div class="descrHotel">
				<p><b>#{d.hotel.nome}</b></p>
				<p>#{d.hotel.indirizzo}</p>
				<p>#{d.hotel.telefono}</p>
			</div>
			<div class="pulsanti">
			<p><h:link value="Modifica" styleClass="detail-button" disabled="#{not pacchetto.tipoPersonalizzato}"/></p>
			<p><h:link value="Dettagli" styleClass="detail-button" outcome="dettagliHotel">
				<f:param name="idPacchetto" value="#{pacchetto.pacchetto.id}" />
				<f:param name="idHotel" value="#{d.hotel.id}" />
			</h:link></p>
			</div>
		</div>
	</div>
		
	<!-- Informazioni sulle escursioni -->
	<div class="bloccoPaccEscursione">
		<p>
			<h:link value="Aggiungi escursione" outcome="aggiuntaEscursione.xhtml" disabled="#{not pacchetto.tipoPersonalizzato}">
				<f:param name="idPacchetto" value="#{pacchetto.pacchetto.id}" />
				<f:param name="idDestinazione" value="#{d.id}" />
				<f:param name="regione" value="#{d.citta.regione}" />
			</h:link>
		</p>
	</div>

	<!-- Collegamento di ritorno (visualizzazto solo nell'ultima destinazione) -->
	<h:panelGroup layout="block" rendered="#{pacchetto.isUltimaDestinazione(d)}">
		<div class="bloccoPaccVolo">
		
		<!-- Data di ritorno -->
		<p>Data di ritorno</p>
		<div id="dataPartenza" style="display: block;">
			<p>
				<h:outputText value="#{d.dataPartenza}">
					<f:convertDateTime pattern="dd/MM/yyyy" timeZone="Europe/Rome" />
				</h:outputText>
			</p>
			<h:commandButton value="modifica" onclick="toggle('dataPartenza'); toggle('modificaDataPartenza'); return false;" rendered="#{pacchetto.tipoPersonalizzato}" />
			<h:commandButton value="modifica" onclick="toggle('dataPartenza'); toggle('modificaDurata'); return false;" rendered="#{pacchetto.tipoPredefinito}" />					
		</div>
		
		<div id="modificaDataPartenza" style="display: none;">
			<h:form>
				<p:calendar value="#{d.dataPartenza}" locale="it" pattern="dd/MM/yyyy"
					required="true" requiredMessage="Inserire una data di partenza"
					converterMessage="Inserire una data di partenza nel formato dd/MM/yyyy (es.: 05/01/2014)">
	           			<f:convertDateTime pattern="dd/MM/yyyy" timeZone="Europe/Rome" />
	           	</p:calendar>
	           	<h:commandButton value="salva" action="#{pacchetto.modificaDataPartenza(d)}" oncomplete="toggle('dataPartenza'); toggle('modificaDataPartenza'); return false;" />
	           	<h:commandButton value="annulla" onclick="toggle('dataPartenza'); toggle('modificaDataPartenza'); return false;" />
           	</h:form>
		</div>
	
		<div id="modificaDurata" style="display: none;">
			<h:form>
				<h:selectOneMenu binding="#{durata}">
					<f:selectItems value="#{pacchetto.predefinito.durate}" />
				</h:selectOneMenu>					
	           	<h:commandButton value="salva" action="#{pacchetto.modificaDurata(durata.value,d)}" oncomplete="toggle('dataPartenza'); toggle('modificaDurata'); return false;" />
	           	<h:commandButton value="annulla" onclick="toggle('dataPartenza'); toggle('modificaDurata'); return false;" />
           	</h:form>				
		</div>		
		
		<h:outputText value="#{pacchetto.getCollegamento(d.dataPartenza).dataPartenza}" rendered="#{pacchetto.isUltimaDestinazione(d) and pacchetto.esisteCollegamento(d.dataPartenza)}">
				<f:convertDateTime pattern="dd/MM/yyyy" timeZone="Europe/Rome" />
		</h:outputText>
			
		<div class="volo">

			<div class="pulsantiVolo">
				<p>
					<h:link value="Dettagli" styleClass="detail-button" outcome="dettagliCollegamento" disabled="#{not pacchetto.esisteCollegamento(d.dataPartenza)}">
						<f:param name="idPacchetto" value="#{pacchetto.pacchetto.id}" />
						<f:param name="codiceCollegamento" value="#{pacchetto.getCollegamento(d.dataPartenza).codice}" />
					</h:link>
				</p>
				<p>
					<h:link value="Modifica" styleClass="detail-button" outcome="aggiuntaCollegamento" disabled="#{not ((pacchetto.tipoPersonalizzato or pacchetto.tipoPredefinito) and pacchetto.esisteCollegamento(d.dataPartenza))}">
						<f:param name="idPacchetto" value="#{pacchetto.pacchetto.id}" />
						<f:param name="dataPartenza" value="#{data.getData(d.dataPartenza)}" />
						<f:param name="cittaPartenza" value="#{d.citta.nome}" />
						<f:param name="cittaArrivo" value="#{pacchetto.pacchetto.citta.nome}" />		
					</h:link>
				</p>
			</div>

			<div class="etichette">
				<ul>
					<li>Da</li>
					<li>A</li>
					<li>Partenza</li>
					<li>Arrivo</li>
					<li>Prezzo</li>
				</ul>
			</div>
				
			<!-- Informazioni sul collegamento -->
			<h:panelGroup styleClass="dati" layout="block" rendered="#{pacchetto.isUltimaDestinazione(d) and pacchetto.esisteCollegamento(d.dataPartenza)}">
				<ul>
					<li>#{pacchetto.getCollegamento(d.dataPartenza).cittaPartenza.nome} #{pacchetto.getCollegamento(d.dataPartenza).origine}</li>
					<li>#{pacchetto.getCollegamento(d.dataPartenza).cittaArrivo.nome} #{pacchetto.getCollegamento(d.dataPartenza).destinazione}</li>
					<li>
						<h:outputText value="#{pacchetto.getCollegamento(d.dataPartenza).oraPartenza}">
							<f:convertDateTime pattern="HH:mm" timeZone="Europe/Rome" />
						</h:outputText>
					</li>
					<li>
						<h:outputText value="#{pacchetto.getCollegamento(d.dataPartenza).oraArrivo}">
							<f:convertDateTime pattern="HH:mm" timeZone="Europe/Rome" />
						</h:outputText>
					</li>
					<li>#{pacchetto.getCollegamento(d.dataPartenza).prezzo} €</li>
				</ul>
			</h:panelGroup>
				
			<!-- Blocco aggiunta volo -->
			<h:panelGroup styleClass="dati" layout="block" rendered="#{pacchetto.isUltimaDestinazione(d) and (not pacchetto.esisteCollegamento(d.dataPartenza))}">
            	<p>
                	<h:link value="Aggiungi collegamento" outcome="aggiuntaCollegamento">
                    	<f:param name="idPacchetto" value="#{pacchetto.pacchetto.id}" />
						<f:param name="dataPartenza" value="#{data.getData(d.dataPartenza)}" />
						<f:param name="cittaPartenza" value="#{d.citta.nome}" />
						<f:param name="cittaArrivo" value="#{pacchetto.pacchetto.citta.nome}" />		
					</h:link>
				</p>
               </h:panelGroup>
				
			</div>		
		</div>	
	</h:panelGroup>
</ui:repeat>
		
<!-- Aggiunta destinazione -->
<p>
	<h:link value="Aggiungi destinazione" outcome="aggiuntaDestinazione" disabled="#{not pacchetto.tipoPersonalizzato}">
		<f:param name="idPacchetto" value="#{pacchetto.pacchetto.id}" />
	</h:link>
</p>

</h:panelGroup>	

<script type="text/javascript">
	function toggle(id) {
		var element = document.getElementById(id);
		if(element.style.display == 'block') {
			element.style.display = 'none';
		} else {
			element.style.display = 'block'
		}
	}
</script>

</ui:define>

</ui:composition>
</html>